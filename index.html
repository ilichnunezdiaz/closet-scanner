<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Closet Scanner</title>

  <!-- PWA manifest -->
  <link rel="manifest" href="data:application/manifest+json,{
    \"name\": \"Closet Scanner\",
    \"short_name\": \"Scanner\",
    \"start_url\": \".\",
    \"display\": \"standalone\",
    \"background_color\": \"#f0f0f0\",
    \"theme_color\": \"#4CAF50\",
    \"icons\": [{\"src\": \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E%F0%9F%93%A6%3C/text%3E%3C/svg%3E\", \"sizes\": \"192x192\", \"type\": \"image/svg+xml\"}]
  }">

  <style>
    body {font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
          margin:20px; background:#f5f5f5; text-align:center;}
    h2 {margin-bottom:10px;}
    button {margin:8px; padding:14px 20px; font-size:18px; background:#4CAF50; color:#fff;
            border:none; border-radius:8px; width:85%;}
    #video {width:100%; max-width:420px; border-radius:12px; margin-top:10px; display:none;}
    #status {font-weight:bold; margin:12px 0; color:#2e7d32;}
    .error {color:#d32f2f;}
    #inventoryList {margin:15px auto; max-width:420px; background:#fff; padding:12px;
                    border-radius:8px; text-align:left; max-height:300px; overflow-y:auto;
                    box-shadow:0 2px 6px rgba(0,0,0,.1); display:none;}
    input {width:80%; padding:12px; margin:10px; font-size:16px; border:1px solid #ccc; border-radius:6px;}
    select {width:80%; padding:12px; margin:8px; font-size:16px; border:1px solid #ccc; border-radius:6px;}
  </style>
</head>
<body>
  <h2>Supply Closet Scanner</h2>

  <button id="startBtn">Start Camera</button>
  <video id="video" autoplay playsinline muted></video>
  <p id="status">Tap to start...</p>

  <!-- Controls (optional – user / location) -->
  <div id="controls" style="margin:10px;">
    <select id="user_select">
      <option value="">Select User</option>
      <option value="Ilich">Ilich</option>
      <option value="Maria">Maria</option>
      <option value="John">John</option>
    </select>
    <select id="location_select">
      <option value="">Select Location</option>
      <option value="Office">Office</option>
      <option value="Freezer">Freezer</option>
      <option value="Storage">Storage</option>
    </select>
  </div>

  <button id="showInventoryBtn">Show Inventory</button>
  <div id="inventoryList"></div>

  <input id="name_input" placeholder="Item name" style="display:none;">
  <button id="save_btn" style="display:none;">Save</button>

  <!-- ZXing barcode scanner -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.18.0/umd/index.min.js"></script>
  <script>
    // -------------------------------------------------
    // CHANGE THIS TO YOUR DEPLOYED WEB-APP URL
    // -------------------------------------------------
    const API = "https://script.google.com/macros/s/AKfycbyKHzGyNnNYlR6qqqIimpAFO8P7W7tqka9dyHtqTgihCv3Nxoy7vhx84PbXASAmfslU/exec";

    let currentBarcode = null;
    const codeReader = new ZXing.BrowserMultiFormatReader();

    const video          = document.getElementById('video');
    const startBtn       = document.getElementById('startBtn');
    const status         = document.getElementById('status');
    const inventoryList  = document.getElementById('inventoryList');
    const showInventoryBtn = document.getElementById('showInventoryBtn');
    const nameInput      = document.getElementById('name_input');
    const saveBtn        = document.getElementById('save_btn');

    // ---- USER / LOCATION SELECTORS ----
    let selectedUser = "", selectedLocation = "";
    document.getElementById('user_select').onchange = e => selectedUser = e.target.value;
    document.getElementById('location_select').onchange = e => selectedLocation = e.target.value;

    // ---- START CAMERA ----
    startBtn.onclick = async () => {
      startBtn.disabled = true;
      startBtn.textContent = "Starting...";
      status.innerText = "Requesting camera...";

      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment", width: { ideal: 640 }, height: { ideal: 480 } }
        });
        video.srcObject = stream;
        video.style.display = "block";
        startBtn.style.display = "none";
        status.innerText = "Scanning...";

        codeReader.decodeFromVideoDevice(null, 'video', result => {
          if (result) {
            currentBarcode = result.text;
            status.innerText = `Found: ${currentBarcode}`;
            codeReader.reset();
            scanBarcode(currentBarcode);
          }
        });
      } catch (err) {
        status.innerHTML = `<span class="error">Camera blocked.<br>Add to Home Screen → Open from icon → Allow camera</span>`;
        startBtn.disabled = false;
        startBtn.textContent = "Try Again";
      }
    };

    // ---- SCAN LOGIC ----
    function scanBarcode(code) {
      fetch(`${API}?code=${encodeURIComponent(code)}`)
        .then(r => r.json())
        .then(data => {
          if (data.action === "ask_name") {
            nameInput.style.display = "block";
            saveBtn.style.display   = "block";
            status.innerText = "Enter item name:";
          } else {
            status.innerText = `${data.action.toUpperCase()}: ${data.name || ""} – Qty ${data.qty || ""}`;
            setTimeout(() => codeReader.reset(), 2000);
          }
        })
        .catch(err => status.innerHTML = `<span class="error">Network error: ${err.message}</span>`);
    }

    // ---- SAVE NAME ----
    saveBtn.onclick = () => {
      const name = nameInput.value.trim();
      if (!name || !currentBarcode) return;
      const qs = `code=${encodeURIComponent(currentBarcode)}&name=${encodeURIComponent(name)}` +
                 (selectedUser ? `&user=${encodeURIComponent(selectedUser)}` : "") +
                 (selectedLocation ? `&loc=${encodeURIComponent(selectedLocation)}` : "");
      fetch(`${API}?${qs}`)
        .then(() => {
          status.innerText = `Added: ${name}`;
          nameInput.style.display = "none";
          saveBtn.style.display   = "none";
          nameInput.value = "";
          setTimeout(() => codeReader.reset(), 2000);
        })
        .catch(err => status.innerHTML = `<span class="error">Save failed: ${err.message}</span>`);
    };

    // ---- SHOW INVENTORY ----
    showInventoryBtn.onclick = () => {
      fetch(`${API}?action=get_inventory`)
        .then(r => r.json())
        .then(data => {
          if (data.action === "inventory" && data.items.length) {
            const html = data.items.map(it => `
              <p><strong>${it[NAME_COL] || "—"}</strong><br>
                 Qty: ${it[QTY_COL] || 0}  Barcode: ${it[BARCODE_COL] || "—"}<br>
                 <small>Last: ${it[LAST_COL] ? new Date(it[LAST_COL]).toLocaleString() : "—"}</small>
              </p><hr>`).join('');
            inventoryList.innerHTML = html;
          } else {
            inventoryList.innerHTML = "<p>No items yet.</p>";
          }
          inventoryList.style.display = "block";
        })
        .catch(err => {
          inventoryList.innerHTML = `<p class="error">Failed to load inventory: ${err.message}</p>`;
          inventoryList.style.display = "block";
        });
    };
  </script>
</body>
</html>
